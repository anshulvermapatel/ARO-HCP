
identity:
  userAssignedIdentities:
    "/subscriptions/1d3378d3-5a3f-4712-85a1-2485495dfc4b/resourcegroups/aro-hcp-dev-image-sync/providers/Microsoft.ManagedIdentity/userAssignedIdentities/image-sync-sxo4oqbcjiekg": {}
  type: UserAssigned
properties:
  environmentId: "/subscriptions/1d3378d3-5a3f-4712-85a1-2485495dfc4b/resourceGroups/aro-hcp-dev-image-sync/providers/Microsoft.App/managedEnvironments/image-sync-env-sxo4oqbcjiekg"
  configuration:
    replicaTimeout: 10000
    replicaRetryLimit: 1
    manualTriggerConfig:
      replicaCompletionCount: 1
      parallelism: 1
    triggerType: Manual
    registries:
      - identity: "/subscriptions/1d3378d3-5a3f-4712-85a1-2485495dfc4b/resourcegroups/aro-hcp-dev-image-sync/providers/Microsoft.ManagedIdentity/userAssignedIdentities/image-sync-sxo4oqbcjiekg"
        server: arohcpdev.azurecr.io
    secrets:
    - name: pull-secrets
      keyVaultUrl: https://aro-hcp-dev-global-kv.vault.azure.net/secrets/jbolltesting
      identity: /subscriptions/1d3378d3-5a3f-4712-85a1-2485495dfc4b/resourcegroups/aro-hcp-dev-image-sync/providers/Microsoft.ManagedIdentity/userAssignedIdentities/image-sync-sxo4oqbcjiekg
    - name: bearer-secret
      keyVaultUrl: https://aro-hcp-dev-global-kv.vault.azure.net/secrets/bearer-secret
      identity: /subscriptions/1d3378d3-5a3f-4712-85a1-2485495dfc4b/resourcegroups/aro-hcp-dev-image-sync/providers/Microsoft.ManagedIdentity/userAssignedIdentities/image-sync-sxo4oqbcjiekg
  template:
    containers:
    - image: arohcpdev.azurecr.io/image-sync/component-sync:testing
      name: sync-components
      volumeMounts:
      - volumeName: pull-secrets-updated
        mountPath: "/etc/containers"
    initContainers:
    - image: mcr.microsoft.com/azure-cli:cbl-mariner2.0
      name: login
      command: 
      - "/bin/sh"
      - "-c"
      - "az login --identity --username 5d766170-b14c-4f75-a2c2-e44ff99d1216; accessToken=$(az acr login --name jbolltesting --expose-token | grep accessToken |cut -d ':' -f2| tr -d ' \",') ; cat /tmp/secret-orig/pull-secrets | base64 -d  |sed \"s/TOKENTOBEREPLACED/$accessToken/\" > /etc/containers/auth.json"
      volumeMounts:
      - volumeName: pull-secrets-updated
        mountPath: "/etc/containers"
      - volumeName: pull-secrets
        mountPath: "/tmp/secret-orig"
      env:
      - name: APPSETTING_WEBSITE_SITE_NAME
        value: https://github.com/microsoft/azure-container-apps/issues/502
    - image: mcr.microsoft.com/azure-cli:cbl-mariner2.0
      name: quay-auth
      command: 
      - "/bin/sh"
      - "-c"
      - "cat /tmp/bearer-secret/bearer-secret | base64 -d > /etc/containers/quayio-auth.json"
      volumeMounts:
      - volumeName: pull-secrets-updated
        mountPath: "/etc/containers"
      - volumeName: bearer-secret
        mountPath: "/tmp/bearer-secret"
    volumes:
    - name: pull-secrets-updated
      storageType: EmptyDir
    - name: pull-secrets
      storageType: Secret
      secrets:
      - secretRef: pull-secrets
    - name: bearer-secret
      storageType: Secret
      secrets:
      - secretRef: bearer-secret

